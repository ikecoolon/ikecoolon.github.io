function initHealthLevelManagement() {
  // DOM ÂÖÉÁ¥†
  const mainView = document.getElementById("main-view");
  const formView = document.getElementById("form-view");
  const formTitle = document.getElementById("form-title");
  const searchInput = document.getElementById("search-health-level");
  const tableBody = document.getElementById("health-level-table-body");
  const addNewLevelButton = document.getElementById("add-new-level");
  const backToListButton = document.getElementById("back-to-list");
  const levelForm = document.getElementById("level-form");
  const formLevelCode = document.getElementById("form-level-code");
  const formLevelName = document.getElementById("form-level-name");
  const formLevelDescription = document.getElementById("form-level-description");
  const formScoreRange = document.getElementById("form-score-range");
  const formColorCode = document.getElementById("form-color-code");
  const formColorText = document.getElementById("form-color-text");
  const formSortOrder = document.getElementById("form-sort-order");
  const cancelFormButton = document.getElementById("cancel-form");

  // Êï∞ÊçÆÂ≠òÂÇ®
  let healthLevels = [];
  let currentEditIndex = -1; // -1 Ë°®Á§∫Êñ∞Â¢ûÔºå>=0 Ë°®Á§∫ÁºñËæë

  // ÂàùÂßãÂåñÊµãËØïÊï∞ÊçÆ
  healthLevels = [
    {
      id: 1,
      code: "A",
      name: "‰ºòÁßÄ",
      description: "Ë∫´‰ΩìÁä∂ÂÜµÊûÅ‰Ω≥ÔºåÂêÑÈ°πÊåáÊ†áÂùáÂú®ÁêÜÊÉ≥ËåÉÂõ¥ÂÜÖÔºåÂÖçÁñ´ÂäõÂº∫ÔºåÁ≤æÂäõÂÖÖÊ≤õÔºåÂª∫ËÆÆ‰øùÊåÅÂΩìÂâçËâØÂ•ΩÁöÑÁîüÊ¥ª‰π†ÊÉØ„ÄÇ",
      scoreRange: "90-100",
      colorCode: "#22c55e",
      sortOrder: 1,
    },
    {
      id: 2,
      code: "B",
      name: "ËâØÂ•Ω",
      description: "Ë∫´‰ΩìÁä∂ÂÜµËâØÂ•ΩÔºåÂ§ßÈÉ®ÂàÜÊåáÊ†áÊ≠£Â∏∏ÔºåÂÅ∂ÊúâËΩªÂæÆÊ≥¢Âä®ÔºåÂª∫ËÆÆÈÄÇÂΩìË∞ÉÊï¥È•ÆÈ£üÂíåËøêÂä®‰π†ÊÉØÔºåÁª¥ÊåÅÂÅ•Â∫∑Áä∂ÊÄÅ„ÄÇ",
      scoreRange: "75-89",
      colorCode: "#84cc16",
      sortOrder: 2,
    },
    {
      id: 3,
      code: "C",
      name: "‰∏ÄËà¨",
      description: "Ë∫´‰ΩìÁä∂ÂÜµ‰∏ÄËà¨ÔºåÈÉ®ÂàÜÊåáÊ†áÂ≠òÂú®ÂºÇÂ∏∏ÔºåÈúÄË¶ÅÂÖ≥Ê≥®È•ÆÈ£üÂÅ•Â∫∑ÔºåÂ¢ûÂä†ËøêÂä®ÈáèÔºåÂÆöÊúüÊ£ÄÊü•Ë∫´‰ΩìÁä∂ÂÜµ„ÄÇ",
      scoreRange: "60-74",
      colorCode: "#f59e0b",
      sortOrder: 3,
    },
    {
      id: 4,
      code: "D",
      name: "ËæÉÂ∑Æ",
      description: "Ë∫´‰ΩìÁä∂ÂÜµ‰∏ç‰Ω≥ÔºåÂ§öÈ°πÊåáÊ†áÂºÇÂ∏∏ÔºåÈúÄË¶ÅÂèäÊó∂Â∞±ÂåªÂí®ËØ¢ÔºåË∞ÉÊï¥ÁîüÊ¥ªÊñπÂºèÔºåÂøÖË¶ÅÊó∂ËøõË°å‰∏ì‰∏öÊ≤ªÁñó„ÄÇ",
      scoreRange: "0-59",
      colorCode: "#ef4444",
      sortOrder: 4,
    },
  ];

  function generateId() {
    return Math.max(...healthLevels.map((l) => l.id || 0), 0) + 1;
  }

  function renderTable(filter = "") {
    // ËøáÊª§Êï∞ÊçÆ
    let filteredLevels = healthLevels.filter(
      (level) =>
        level.code.toLowerCase().includes(filter.toLowerCase()) ||
        level.name.toLowerCase().includes(filter.toLowerCase()) ||
        level.description.toLowerCase().includes(filter.toLowerCase())
    );

    // ÊåâÊéíÂ∫èÊùÉÈáçÊéíÂ∫è
    filteredLevels.sort((a, b) => (a.sortOrder || 999) - (b.sortOrder || 999));

    tableBody.innerHTML = "";

    if (filteredLevels.length === 0) {
      tableBody.innerHTML = `
                <tr>
                    <td colspan="7" class="px-6 py-4 text-center text-gray-500">ÊöÇÊó†ÂÅ•Â∫∑ÂàÜÁ∫ßÈÖçÁΩÆ</td>
                </tr>
            `;
      return;
    }

    filteredLevels.forEach((item) => {
      const row = document.createElement("tr");
      row.className = "hover:bg-gray-50";
      row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="flex items-center">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium text-white" style="background-color: ${
                          item.colorCode
                        };">
                            ${item.code}
                        </span>
                    </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm font-medium text-gray-900">${
                      item.name
                    }</div>
                </td>
                <td class="px-6 py-4">
                    <div class="text-sm text-gray-900 max-w-md">${
                      item.description.length > 50
                        ? item.description.substring(0, 50) + "..."
                        : item.description
                    }</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="text-sm text-gray-500">${
                      item.scoreRange || "-"
                    }</span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="flex items-center">
                        <div class="w-4 h-4 rounded-full mr-2" style="background-color: ${
                          item.colorCode
                        };"></div>
                        <span class="text-sm text-gray-500">${
                          item.colorCode
                        }</span>
                    </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="text-sm text-gray-500">${
                      item.sortOrder || "-"
                    }</span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                    <button class="text-blue-600 hover:text-blue-900 mr-3 edit-level" data-id="${
                      item.id
                    }">
                        <i class="fas fa-edit mr-1"></i>ÁºñËæë
                    </button>
                    <button class="text-green-600 hover:text-green-900 mr-3 client-edit-level" data-id="${
                      item.id
                    }">
                        <i class="fas fa-user-edit mr-1"></i>ÂÆ¢Êà∑ÁºñËæë
                    </button>
                    <button class="text-red-600 hover:text-red-900 delete-level" data-id="${
                      item.id
                    }">
                        <i class="fas fa-trash mr-1"></i>Âà†Èô§
                    </button>
                </td>
            `;
      tableBody.appendChild(row);
    });
  }

  function showMainView() {
    mainView.classList.remove("hidden");
    formView.classList.add("hidden");
    renderTable();
  }

  function showFormView(isEdit = false, editId = null, isClientEdit = false) {
    mainView.classList.add("hidden");
    formView.classList.remove("hidden");

    // ÈáçÁΩÆÊâÄÊúâÂ≠óÊÆµ‰∏∫ÂèØÁºñËæëÁä∂ÊÄÅ
    formLevelCode.disabled = false;
    formLevelCode.style.backgroundColor = "";
    
    // ÁßªÈô§ÂÆ¢Êà∑ÁºñËæëÊèêÁ§∫
    removeClientEditHints();

    if (isEdit && editId) {
      const item = healthLevels.find((l) => l.id === editId);
      if (item) {
        if (isClientEdit) {
          formTitle.textContent = "ÂÆ¢Êà∑ÁºñËæëÂÅ•Â∫∑ÂàÜÁ∫ß";
          // ÂÆ¢Êà∑ÁºñËæëÊ®°ÂºèÔºöÁ¶ÅÁî®ÂàÜÁ∫ß‰ª£Á†ÅÂ≠óÊÆµ
          formLevelCode.disabled = true;
          formLevelCode.style.backgroundColor = "#f3f4f6";
          
          // Ê∑ªÂä†ÂÆ¢Êà∑ÁºñËæëÊ®°ÂºèÁöÑÊèêÁ§∫
          addClientEditHints();
        } else {
          formTitle.textContent = "ÁºñËæëÂÅ•Â∫∑ÂàÜÁ∫ß";
        }
        formLevelCode.value = item.code;
        formLevelName.value = item.name;
        formLevelDescription.value = item.description;
        formScoreRange.value = item.scoreRange || "";
        formColorCode.value = item.colorCode;
        formColorText.value = item.colorCode;
        formSortOrder.value = item.sortOrder || "";
        currentEditIndex = healthLevels.findIndex((l) => l.id === editId);
      }
    } else {
      formTitle.textContent = "Êñ∞Â¢ûÂÅ•Â∫∑ÂàÜÁ∫ß";
      levelForm.reset();
      formColorCode.value = "#22c55e";
      formColorText.value = "#22c55e";
      currentEditIndex = -1;
    }
  }

  function addClientEditHints() {
    // ‰∏∫ÂàÜÁ∫ß‰ª£Á†ÅÂ≠óÊÆµÊ∑ªÂä†ÊèêÁ§∫
    const codeContainer = formLevelCode.parentElement;
    if (!codeContainer.querySelector('.client-edit-hint')) {
      const codeHint = document.createElement('p');
      codeHint.className = 'client-edit-hint text-sm text-gray-500 mt-1';
      codeHint.textContent = 'üîí ÂÆ¢Êà∑ÁºñËæëÊ®°Âºè‰∏ãÊ≠§Â≠óÊÆµ‰∏çÂèØ‰øÆÊîπ';
      codeContainer.appendChild(codeHint);
    }
  }

  function removeClientEditHints() {
    // ÁßªÈô§ÊâÄÊúâÂÆ¢Êà∑ÁºñËæëÊèêÁ§∫
    document.querySelectorAll('.client-edit-hint').forEach(hint => {
      hint.remove();
    });
  }

  // È¢úËâ≤ÈÄâÊã©Âô®ËÅîÂä®
  formColorCode.addEventListener("input", (e) => {
    formColorText.value = e.target.value;
  });

  formColorText.addEventListener("input", (e) => {
    const color = e.target.value;
    if (/^#[0-9A-F]{6}$/i.test(color)) {
      formColorCode.value = color;
    }
  });

  // ‰∫ã‰ª∂ÁõëÂê¨Âô®
  addNewLevelButton.addEventListener("click", () => {
    showFormView(false);
  });

  backToListButton.addEventListener("click", showMainView);
  cancelFormButton.addEventListener("click", showMainView);

  levelForm.addEventListener("submit", (e) => {
    e.preventDefault();

    const code = formLevelCode.value.trim().toUpperCase();
    const name = formLevelName.value.trim();
    const description = formLevelDescription.value.trim();
    const scoreRange = formScoreRange.value.trim();
    const colorCode = formColorCode.value;
    const sortOrder = parseInt(formSortOrder.value) || 999;

    if (!code || !name || !description) {
      alert("ÂàÜÁ∫ß‰ª£Á†Å„ÄÅÂàÜÁ∫ßÂêçÁß∞ÂíåÂÅ•Â∫∑ÊèèËø∞‰∏çËÉΩ‰∏∫Á©∫ÔºÅ");
      return;
    }

    // Ê£ÄÊü•‰ª£Á†ÅÊòØÂê¶ÈáçÂ§ç
    const existingLevel = healthLevels.find(
      (l) =>
        l.code === code &&
        (currentEditIndex === -1 || l.id !== healthLevels[currentEditIndex].id)
    );
    if (existingLevel) {
      alert("ÂàÜÁ∫ß‰ª£Á†ÅÂ∑≤Â≠òÂú®ÔºåËØ∑‰ΩøÁî®ÂÖ∂‰ªñ‰ª£Á†ÅÔºÅ");
      return;
    }

    if (currentEditIndex >= 0) {
      // ÁºñËæë
      healthLevels[currentEditIndex] = {
        ...healthLevels[currentEditIndex],
        code,
        name,
        description,
        scoreRange,
        colorCode,
        sortOrder,
      };
    } else {
      // Êñ∞Â¢û
      healthLevels.push({
        id: generateId(),
        code,
        name,
        description,
        scoreRange,
        colorCode,
        sortOrder,
      });
    }

    showMainView();
  });

  // Ë°®Ê†ºÊìç‰Ωú‰∫ã‰ª∂‰ª£ÁêÜ
  tableBody.addEventListener("click", (e) => {
    if (
      e.target.classList.contains("edit-level") ||
      e.target.closest(".edit-level")
    ) {
      const button = e.target.classList.contains("edit-level")
        ? e.target
        : e.target.closest(".edit-level");
      const id = parseInt(button.dataset.id);
      showFormView(true, id);
    } else if (
      e.target.classList.contains("client-edit-level") ||
      e.target.closest(".client-edit-level")
    ) {
      const button = e.target.classList.contains("client-edit-level")
        ? e.target
        : e.target.closest(".client-edit-level");
      const id = parseInt(button.dataset.id);
      showFormView(true, id, true); // Á¨¨‰∏â‰∏™ÂèÇÊï∞‰∏∫trueË°®Á§∫ÂÆ¢Êà∑ÁºñËæëÊ®°Âºè
    } else if (
      e.target.classList.contains("delete-level") ||
      e.target.closest(".delete-level")
    ) {
      const button = e.target.classList.contains("delete-level")
        ? e.target
        : e.target.closest(".delete-level");
      const id = parseInt(button.dataset.id);

      const level = healthLevels.find((l) => l.id === id);
      if (
        confirm(
          `Á°ÆÂÆöË¶ÅÂà†Èô§ÂÅ•Â∫∑ÂàÜÁ∫ß "${level.code} - ${level.name}" ÂêóÔºü\nÂà†Èô§ÂêéÂ∞ÜÊó†Ê≥ïÊÅ¢Â§ç„ÄÇ`
        )
      ) {
        healthLevels = healthLevels.filter((l) => l.id !== id);
        renderTable();
      }
    }
  });

  searchInput.addEventListener("input", (e) => {
    renderTable(e.target.value.trim());
  });

  // ÂàùÂßãÂåñ
  showMainView();
}

// Â¶ÇÊûú DOM Â∑≤Âä†ËΩΩÂÆåÊàêÔºåÁ´ãÂç≥ÊâßË°åÔºõÂê¶ÂàôÁ≠âÂæÖ DOMContentLoaded ‰∫ã‰ª∂
if (document.readyState === "loading") {
  document.addEventListener("DOMContentLoaded", initHealthLevelManagement);
} else {
  initHealthLevelManagement();
}
